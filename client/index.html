<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>HXP — Human Execution Protocol</title>
  <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;600&family=DM+Sans:wght@400;500;600;700&display=swap" rel="stylesheet">
  <style>
    :root {
      --bg: #0a0a0b;
      --surface: #141416;
      --surface-hover: #1a1a1e;
      --border: #2a2a30;
      --text: #e8e8ec;
      --text-muted: #8888a0;
      --accent: #7c6cff;
      --accent-soft: rgba(124, 108, 255, 0.12);
      --green: #34d399;
      --green-soft: rgba(52, 211, 153, 0.12);
      --red: #f87171;
      --red-soft: rgba(248, 113, 113, 0.12);
      --yellow: #fbbf24;
      --yellow-soft: rgba(251, 191, 36, 0.12);
      --blue: #60a5fa;
      --radius: 12px;
      --mono: 'JetBrains Mono', monospace;
      --sans: 'DM Sans', -apple-system, sans-serif;
    }

    * { margin: 0; padding: 0; box-sizing: border-box; }
    
    body {
      font-family: var(--sans);
      background: var(--bg);
      color: var(--text);
      min-height: 100vh;
      -webkit-font-smoothing: antialiased;
    }

    /* Layout */
    .app {
      max-width: 640px;
      margin: 0 auto;
      padding: 24px 16px;
      min-height: 100vh;
    }

    /* Header */
    .header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 16px 0 32px;
      border-bottom: 1px solid var(--border);
      margin-bottom: 24px;
    }
    .header-left {
      display: flex;
      align-items: center;
      gap: 12px;
    }
    .logo {
      font-family: var(--mono);
      font-size: 20px;
      font-weight: 600;
      color: var(--accent);
      letter-spacing: -0.5px;
    }
    .badge {
      font-family: var(--mono);
      font-size: 11px;
      padding: 3px 8px;
      border-radius: 6px;
      font-weight: 600;
    }
    .badge-count {
      background: var(--accent-soft);
      color: var(--accent);
    }
    .badge-connected {
      background: var(--green-soft);
      color: var(--green);
    }
    .badge-disconnected {
      background: var(--red-soft);
      color: var(--red);
    }

    /* Config bar */
    .config {
      display: flex;
      gap: 8px;
      margin-bottom: 24px;
    }
    .config input {
      flex: 1;
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: 8px;
      padding: 8px 12px;
      color: var(--text);
      font-family: var(--mono);
      font-size: 13px;
      outline: none;
      transition: border-color 0.2s;
    }
    .config input:focus {
      border-color: var(--accent);
    }
    .config button {
      padding: 8px 16px;
      background: var(--accent);
      color: white;
      border: none;
      border-radius: 8px;
      font-family: var(--sans);
      font-weight: 600;
      font-size: 13px;
      cursor: pointer;
      transition: opacity 0.2s;
      white-space: nowrap;
    }
    .config button:hover { opacity: 0.85; }

    /* Tabs */
    .tabs {
      display: flex;
      gap: 4px;
      margin-bottom: 20px;
      background: var(--surface);
      padding: 4px;
      border-radius: 10px;
    }
    .tab {
      flex: 1;
      padding: 8px;
      text-align: center;
      border-radius: 8px;
      font-size: 13px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
      color: var(--text-muted);
      border: none;
      background: transparent;
    }
    .tab.active {
      background: var(--bg);
      color: var(--text);
    }
    .tab:hover:not(.active) {
      color: var(--text);
    }

    /* Empty state */
    .empty {
      text-align: center;
      padding: 80px 20px;
      color: var(--text-muted);
    }
    .empty-icon {
      font-size: 48px;
      margin-bottom: 16px;
      opacity: 0.4;
    }
    .empty h3 {
      font-size: 16px;
      margin-bottom: 8px;
      color: var(--text);
    }
    .empty p {
      font-size: 14px;
      line-height: 1.5;
    }

    /* Request cards */
    .request-card {
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      padding: 20px;
      margin-bottom: 12px;
      transition: border-color 0.2s;
      animation: slideIn 0.3s ease-out;
    }
    .request-card:hover {
      border-color: #3a3a44;
    }
    @keyframes slideIn {
      from { opacity: 0; transform: translateY(8px); }
      to { opacity: 1; transform: translateY(0); }
    }

    .request-meta {
      display: flex;
      align-items: center;
      gap: 8px;
      margin-bottom: 14px;
      flex-wrap: wrap;
    }
    .action-badge {
      font-family: var(--mono);
      font-size: 11px;
      padding: 3px 8px;
      border-radius: 6px;
      font-weight: 600;
      text-transform: uppercase;
    }
    .action-DECIDE { background: var(--accent-soft); color: var(--accent); }
    .action-APPROVE { background: var(--yellow-soft); color: var(--yellow); }
    .action-PROVIDE { background: var(--green-soft); color: var(--green); }

    .priority-badge {
      font-family: var(--mono);
      font-size: 10px;
      padding: 2px 6px;
      border-radius: 4px;
      text-transform: uppercase;
    }
    .priority-critical { background: var(--red-soft); color: var(--red); }
    .priority-high { background: var(--yellow-soft); color: var(--yellow); }
    .priority-normal { color: var(--text-muted); }
    .priority-low { color: var(--text-muted); opacity: 0.6; }

    .request-agent {
      font-family: var(--mono);
      font-size: 11px;
      color: var(--text-muted);
      margin-left: auto;
    }

    .request-question {
      font-size: 16px;
      font-weight: 600;
      line-height: 1.4;
      margin-bottom: 8px;
    }

    .request-context {
      font-size: 13px;
      color: var(--text-muted);
      line-height: 1.5;
      margin-bottom: 16px;
      padding: 10px 12px;
      background: var(--bg);
      border-radius: 8px;
    }

    .request-details {
      font-family: var(--mono);
      font-size: 12px;
      color: var(--text-muted);
      padding: 10px 12px;
      background: var(--bg);
      border-radius: 8px;
      margin-bottom: 16px;
      white-space: pre-wrap;
      word-break: break-all;
    }

    /* Action buttons */
    .request-actions {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
    }
    .btn {
      padding: 10px 20px;
      border-radius: 8px;
      font-family: var(--sans);
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.15s;
      border: 1px solid transparent;
      flex: 1;
      min-width: 100px;
      text-align: center;
    }
    .btn:active { transform: scale(0.97); }
    
    .btn-primary {
      background: var(--accent);
      color: white;
    }
    .btn-primary:hover { opacity: 0.85; }
    
    .btn-approve {
      background: var(--green);
      color: #0a0a0b;
    }
    .btn-approve:hover { opacity: 0.85; }
    
    .btn-reject {
      background: var(--red-soft);
      color: var(--red);
      border-color: rgba(248, 113, 113, 0.2);
    }
    .btn-reject:hover { background: rgba(248, 113, 113, 0.2); }
    
    .btn-option {
      background: var(--surface-hover);
      color: var(--text);
      border-color: var(--border);
    }
    .btn-option:hover {
      border-color: var(--accent);
      background: var(--accent-soft);
    }

    /* Provide input */
    .provide-input {
      width: 100%;
      background: var(--bg);
      border: 1px solid var(--border);
      border-radius: 8px;
      padding: 10px 12px;
      color: var(--text);
      font-family: var(--sans);
      font-size: 14px;
      outline: none;
      margin-bottom: 12px;
      transition: border-color 0.2s;
    }
    .provide-input:focus {
      border-color: var(--accent);
    }

    /* Reason input */
    .reason-input {
      width: 100%;
      background: var(--bg);
      border: 1px solid var(--border);
      border-radius: 8px;
      padding: 8px 12px;
      color: var(--text);
      font-family: var(--sans);
      font-size: 13px;
      outline: none;
      margin-top: 8px;
      display: none;
      transition: border-color 0.2s;
    }
    .reason-input:focus {
      border-color: var(--accent);
    }
    .reason-input.visible {
      display: block;
    }

    /* Completed card */
    .request-card.completed {
      opacity: 0.6;
    }
    .completed-result {
      font-family: var(--mono);
      font-size: 13px;
      padding: 8px 12px;
      background: var(--green-soft);
      color: var(--green);
      border-radius: 8px;
      display: inline-block;
    }

    /* Time */
    .request-time {
      font-size: 11px;
      color: var(--text-muted);
      margin-top: 12px;
      font-family: var(--mono);
    }

    /* Responsive */
    @media (max-width: 480px) {
      .request-actions { flex-direction: column; }
      .btn { flex: unset; }
      .config { flex-direction: column; }
    }

    /* Loading pulse */
    .pulse {
      display: inline-block;
      width: 8px;
      height: 8px;
      border-radius: 50%;
      background: var(--accent);
      animation: pulse 2s infinite;
    }
    @keyframes pulse {
      0%, 100% { opacity: 0.3; }
      50% { opacity: 1; }
    }

    /* Toast notification */
    .toast {
      position: fixed;
      bottom: 24px;
      left: 50%;
      transform: translateX(-50%) translateY(100px);
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: 10px;
      padding: 12px 20px;
      font-size: 13px;
      font-weight: 500;
      box-shadow: 0 8px 32px rgba(0,0,0,0.4);
      transition: transform 0.3s ease;
      z-index: 100;
    }
    .toast.visible {
      transform: translateX(-50%) translateY(0);
    }
  </style>
</head>
<body>
  <div class="app">
    <!-- Header -->
    <div class="header">
      <div class="header-left">
        <div class="logo">HXP</div>
        <span class="badge badge-count" id="pendingCount">0 pending</span>
      </div>
      <span class="badge" id="connectionBadge">●&nbsp; offline</span>
    </div>

    <!-- Config -->
    <div class="config">
      <input type="text" id="serverUrl" value="http://localhost:3402" placeholder="HXP server URL">
      <input type="text" id="humanToken" value="dev-human-token" placeholder="Your token">
      <button onclick="connect()">Connect</button>
    </div>

    <!-- Tabs -->
    <div class="tabs">
      <button class="tab active" onclick="switchTab('pending')">Pending</button>
      <button class="tab" onclick="switchTab('completed')">Completed</button>
    </div>

    <!-- Request list -->
    <div id="requestList"></div>
  </div>

  <!-- Toast -->
  <div class="toast" id="toast"></div>

  <script>
    // State
    let serverUrl = '';
    let humanToken = '';
    let allRequests = [];
    let currentTab = 'pending';
    let pollInterval = null;

    // Connect to server
    function connect() {
      serverUrl = document.getElementById('serverUrl').value.replace(/\/+$/, '');
      humanToken = document.getElementById('humanToken').value;
      
      fetchRequests();
      
      // Start polling
      if (pollInterval) clearInterval(pollInterval);
      pollInterval = setInterval(fetchRequests, 3000);
      
      updateConnectionBadge(true);
    }

    // Fetch pending requests
    async function fetchRequests() {
      try {
        const res = await fetch(`${serverUrl}/hxp/v1/inbox`, {
          headers: { 'Authorization': `Bearer ${humanToken}` }
        });
        if (!res.ok) throw new Error(`HTTP ${res.status}`);
        
        const data = await res.json();
        
        // Check for new requests
        const newIds = data.requests.map(r => r.request_id);
        const oldIds = allRequests.filter(r => r.status === 'pending').map(r => r.request_id);
        const brandNew = newIds.filter(id => !oldIds.includes(id));
        if (brandNew.length > 0 && allRequests.length > 0) {
          showToast(`${brandNew.length} new request${brandNew.length > 1 ? 's' : ''}`);
        }

        // Merge: keep completed from local state, update pending from server
        const completedLocal = allRequests.filter(r => r.status === 'completed');
        allRequests = [...data.requests, ...completedLocal];
        
        updateUI();
        updateConnectionBadge(true);
      } catch (err) {
        console.error('Fetch error:', err);
        updateConnectionBadge(false);
      }
    }

    // Resolve a request
    async function resolveRequest(requestId, result, reason = null) {
      try {
        const body = { result };
        if (reason) body.reason = reason;

        const res = await fetch(`${serverUrl}/hxp/v1/requests/${requestId}/resolve`, {
          method: 'POST',
          headers: {
            'Authorization': `Bearer ${humanToken}`,
            'Content-Type': 'application/json'
          },
          body: JSON.stringify(body)
        });

        if (!res.ok) {
          const err = await res.json();
          showToast(`Error: ${err.message || 'Failed to resolve'}`);
          return;
        }

        const data = await res.json();
        
        // Update local state
        const req = allRequests.find(r => r.request_id === requestId);
        if (req) {
          req.status = 'completed';
          req.receipt = data.receipt;
        }

        showToast(`✓ Resolved: ${result}`);
        updateUI();
      } catch (err) {
        showToast(`Error: ${err.message}`);
      }
    }

    // UI Updates
    function updateUI() {
      const list = document.getElementById('requestList');
      const filtered = currentTab === 'pending'
        ? allRequests.filter(r => r.status === 'pending' || r.status === 'assigned')
        : allRequests.filter(r => r.status === 'completed');

      const pendingCount = allRequests.filter(r => r.status === 'pending' || r.status === 'assigned').length;
      document.getElementById('pendingCount').textContent = `${pendingCount} pending`;

      if (filtered.length === 0) {
        list.innerHTML = currentTab === 'pending'
          ? `<div class="empty">
               <div class="empty-icon">◇</div>
               <h3>No pending requests</h3>
               <p>When your agents need human input,<br>requests will appear here.</p>
             </div>`
          : `<div class="empty">
               <div class="empty-icon">✓</div>
               <h3>No completed requests yet</h3>
               <p>Resolved requests will show here.</p>
             </div>`;
        return;
      }

      list.innerHTML = filtered.map(req => renderCard(req)).join('');
    }

    function renderCard(req) {
      const isCompleted = req.status === 'completed';
      const timeAgo = getTimeAgo(req.created_at);

      let content = '';
      let actions = '';

      if (isCompleted) {
        content = renderCompletedContent(req);
      } else {
        switch (req.action) {
          case 'DECIDE':
            content = `
              <div class="request-question">${escHtml(req.payload.question)}</div>
              ${req.payload.context ? `<div class="request-context">${escHtml(req.payload.context)}</div>` : ''}
            `;
            actions = `
              <div class="request-actions">
                ${req.payload.options.map(opt => 
                  `<button class="btn btn-option" onclick="resolveRequest('${req.request_id}', '${escAttr(opt)}')">${escHtml(opt)}</button>`
                ).join('')}
              </div>
            `;
            break;

          case 'APPROVE':
            content = `
              <div class="request-question">${escHtml(req.payload.item)}</div>
              ${req.payload.details ? `<div class="request-details">${JSON.stringify(req.payload.details, null, 2)}</div>` : ''}
              ${req.payload.context ? `<div class="request-context">${escHtml(req.payload.context)}</div>` : ''}
            `;
            actions = `
              <div class="request-actions">
                <button class="btn btn-approve" onclick="resolveRequest('${req.request_id}', 'approved')">Approve</button>
                <button class="btn btn-reject" onclick="handleReject('${req.request_id}', ${!!req.payload.reject_requires_reason})">Reject</button>
              </div>
              <input class="reason-input" id="reason-${req.request_id}" placeholder="Reason for rejection..." 
                     onkeydown="if(event.key==='Enter') submitReject('${req.request_id}')">
            `;
            break;

          case 'PROVIDE':
            const inputType = req.payload.input_type === 'number' ? 'number' : 
                              req.payload.input_type === 'email' ? 'email' :
                              req.payload.input_type === 'url' ? 'url' : 'text';
            content = `
              <div class="request-question">${escHtml(req.payload.prompt)}</div>
              ${req.payload.context ? `<div class="request-context">${escHtml(req.payload.context)}</div>` : ''}
            `;
            actions = `
              <input class="provide-input" id="provide-${req.request_id}" 
                     type="${inputType}"
                     placeholder="${escAttr(req.payload.placeholder || 'Enter value...')}"
                     onkeydown="if(event.key==='Enter') submitProvide('${req.request_id}')">
              <div class="request-actions">
                <button class="btn btn-primary" onclick="submitProvide('${req.request_id}')">Submit</button>
              </div>
            `;
            break;
        }
      }

      return `
        <div class="request-card ${isCompleted ? 'completed' : ''}">
          <div class="request-meta">
            <span class="action-badge action-${req.action}">${req.action}</span>
            ${req.priority !== 'normal' ? `<span class="priority-badge priority-${req.priority}">${req.priority}</span>` : ''}
            <span class="request-agent">${escHtml(req.agent_id || '')}${req.project_id ? ' / ' + escHtml(req.project_id) : ''}</span>
          </div>
          ${content}
          ${actions}
          <div class="request-time">${timeAgo}${req.expires_at ? ' · expires ' + getTimeAgo(req.expires_at) : ''}</div>
        </div>
      `;
    }

    function renderCompletedContent(req) {
      const result = req.receipt ? req.receipt.result : '—';
      return `
        <div class="request-question" style="opacity: 0.7">
          ${req.action === 'DECIDE' ? escHtml(req.payload.question) : 
            req.action === 'APPROVE' ? escHtml(req.payload.item) : 
            escHtml(req.payload.prompt)}
        </div>
        <div class="completed-result">→ ${escHtml(String(result))}</div>
        ${req.receipt && req.receipt.reason ? `<div class="request-context" style="margin-top:8px">Reason: ${escHtml(req.receipt.reason)}</div>` : ''}
      `;
    }

    // Action handlers
    function handleReject(requestId, requiresReason) {
      const reasonInput = document.getElementById(`reason-${requestId}`);
      if (requiresReason) {
        reasonInput.classList.add('visible');
        reasonInput.focus();
      } else {
        resolveRequest(requestId, 'rejected');
      }
    }

    function submitReject(requestId) {
      const reason = document.getElementById(`reason-${requestId}`).value;
      resolveRequest(requestId, 'rejected', reason || null);
    }

    function submitProvide(requestId) {
      const value = document.getElementById(`provide-${requestId}`).value;
      if (!value) {
        showToast('Please enter a value');
        return;
      }
      resolveRequest(requestId, value);
    }

    // Tab switching
    function switchTab(tab) {
      currentTab = tab;
      document.querySelectorAll('.tab').forEach((t, i) => {
        t.classList.toggle('active', (i === 0 && tab === 'pending') || (i === 1 && tab === 'completed'));
      });
      updateUI();
    }

    // Connection badge
    function updateConnectionBadge(connected) {
      const badge = document.getElementById('connectionBadge');
      if (connected) {
        badge.className = 'badge badge-connected';
        badge.innerHTML = '●&nbsp; connected';
      } else {
        badge.className = 'badge badge-disconnected';
        badge.innerHTML = '●&nbsp; offline';
      }
    }

    // Toast
    function showToast(message) {
      const toast = document.getElementById('toast');
      toast.textContent = message;
      toast.classList.add('visible');
      setTimeout(() => toast.classList.remove('visible'), 2500);
    }

    // Helpers
    function escHtml(str) {
      const div = document.createElement('div');
      div.textContent = str;
      return div.innerHTML;
    }
    function escAttr(str) {
      return str.replace(/'/g, "\\'").replace(/"/g, '&quot;');
    }
    function getTimeAgo(iso) {
      const diff = Date.now() - new Date(iso).getTime();
      const mins = Math.floor(diff / 60000);
      if (mins < 1) return 'just now';
      if (mins < 60) return `${mins}m ago`;
      const hrs = Math.floor(mins / 60);
      if (hrs < 24) return `${hrs}h ago`;
      return `${Math.floor(hrs / 24)}d ago`;
    }

    // Initial render
    updateUI();
  </script>
</body>
</html>
